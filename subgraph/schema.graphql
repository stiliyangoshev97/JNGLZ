# ============================================
# JunkieFun Subgraph - Entity Schema (v3.5.0)
# ============================================
# Indexes PredictionMarket contract events on BNB Chain
# Provides GraphQL API for frontend queries
# v3.5.0: Added P/L tracking for leaderboard

# ============================================
# Market Entity - Core prediction market data
# ============================================
type Market @entity(immutable: false) {
  id: ID! # marketId as string
  marketId: BigInt! # On-chain market ID
  # Market Info
  question: String! # The prediction question
  evidenceLink: String! # Source of truth URL
  resolutionRules: String! # How to resolve
  imageUrl: String! # Market thumbnail image URL
  creator: User! # Creator (relation)
  creatorAddress: Bytes! # Creator address (for filtering)
  # Heat Level (v3.1.0 - updated v3.5.0: 5 tiers)
  heatLevel: Int! # 0=CRACK, 1=HIGH, 2=PRO, 3=APEX, 4=CORE
  virtualLiquidity: BigInt! # Virtual liquidity (50e18, 200e18, 500e18, 2000e18, 10000e18)
  # Timestamps
  expiryTimestamp: BigInt! # When trading stops
  createdAt: BigInt! # Block timestamp
  createdAtBlock: BigInt! # Block number
  # Bonding Curve State
  yesShares: BigInt! # Total YES shares minted
  noShares: BigInt! # Total NO shares minted
  poolBalance: BigInt! # Total BNB in pool (wei)
  # Volume & Stats
  totalVolume: BigDecimal! # Total BNB volume traded
  totalTrades: BigInt! # Number of trades
  # Resolution State
  status: String! # Active, Expired, Proposed, Disputed, VotingEnded, Resolved
  resolved: Boolean! # Is market resolved?
  outcome: Boolean # null if not resolved, true=YES, false=NO
  # Proposal Info (Street Consensus)
  proposer: Bytes # Who proposed the outcome
  proposedOutcome: Boolean # What they proposed
  proposerBond: BigInt # Bond amount
  proposalTimestamp: BigInt # When proposed
  # Dispute Info
  disputer: Bytes # Who disputed
  disputerBond: BigInt # Disputer's bond
  disputeTimestamp: BigInt # When disputed
  # Voting Results
  proposerVoteWeight: BigInt! # Total votes for proposer
  disputerVoteWeight: BigInt! # Total votes for disputer
  totalVoters: BigInt! # Number of voters
  # Relations
  trades: [Trade!]! @derivedFrom(field: "market")
  positions: [Position!]! @derivedFrom(field: "market")
  votes: [Vote!]! @derivedFrom(field: "market")
  claims: [Claim!]! @derivedFrom(field: "market")
}

# ============================================
# Trade Entity - Buy/Sell transactions
# ============================================
type Trade @entity(immutable: true) {
  id: ID! # txHash-logIndex
  market: Market! # Related market
  trader: User! # Trader (relation)
  traderAddress: Bytes! # Trader address (for filtering)
  # Trade Details
  isYes: Boolean! # YES or NO side
  isBuy: Boolean! # Buy or Sell
  shares: BigInt! # Shares traded
  bnbAmount: BigDecimal! # BNB amount
  # Price at time of trade (calculated)
  pricePerShare: BigDecimal! # BNB per share
  # Transaction Info
  timestamp: BigInt! # Block timestamp
  txHash: Bytes! # Transaction hash
  blockNumber: BigInt! # Block number
  logIndex: BigInt! # Log index within tx
}

# ============================================
# User Entity - Trader profiles with P/L for Leaderboard
# ============================================
type User @entity(immutable: false) {
  id: ID! # User address as string
  address: Bytes! # User address
  # Stats
  totalTrades: BigInt! # Total number of trades
  totalVolume: BigDecimal! # Total BNB volume
  marketsCreated: BigInt! # Markets created by user
  # P&L Tracking (Basic)
  totalClaimed: BigDecimal! # Total winnings claimed
  totalRefunded: BigDecimal! # Total emergency refunds
  # ============================================
  # P/L TRACKING FOR LEADERBOARD (v3.5.0)
  # ============================================
  # Trading P/L (buy/sell)
  totalBought: BigDecimal! # Total BNB spent buying shares
  totalSold: BigDecimal! # Total BNB received from selling
  tradingPnL: BigDecimal! # totalSold - totalBought (realized trading P/L)
  # Resolution P/L (claims from resolved markets)
  totalInvestedInResolved: BigDecimal! # BNB invested in markets that resolved
  totalClaimedFromResolved: BigDecimal! # BNB claimed from resolved markets (wins)
  resolutionPnL: BigDecimal! # totalClaimedFromResolved - totalInvestedInResolved
  # Combined P/L
  totalPnL: BigDecimal! # tradingPnL + resolutionPnL (ALL-TIME P/L)
  # Leaderboard Stats
  winCount: BigInt! # Number of winning positions (claimed > 0)
  lossCount: BigInt! # Number of losing positions (resolved with 0 claim)
  winRate: BigDecimal! # winCount / (winCount + lossCount) * 100
  # Resolution Earnings (separate from P/L - only tracks gains, not losses)
  totalProposerRewardsEarned: BigDecimal! # 0.5% pool rewards for correct proposals
  totalBondEarnings: BigDecimal! # 50% of loser's bond when winning disputes (proposer or disputer)
  totalJuryFeesEarned: BigDecimal! # Jury fees earned from voting correctly
  # Creator Earnings (passive income - separate from resolution earnings)
  totalCreatorFeesEarned: BigDecimal! # 0.5% of all trades on markets created
  # Withdrawal Tracking (Pull Pattern)
  pendingWithdrawals: BigDecimal! # Unclaimed bonds/jury fees
  pendingCreatorFees: BigDecimal! # Unclaimed creator fees
  totalWithdrawn: BigDecimal! # Total amount withdrawn via Pull Pattern
  # Relations
  positions: [Position!]! @derivedFrom(field: "user")
  trades: [Trade!]! @derivedFrom(field: "trader")
  votes: [Vote!]! @derivedFrom(field: "voter")
  marketsCreatedList: [Market!]! @derivedFrom(field: "creator")
}

# ============================================
# Position Entity - User positions per market (v3.5.0 - P/L tracking)
# ============================================
type Position @entity(immutable: false) {
  id: ID! # marketId-userAddress
  user: User! # Related user
  market: Market! # Related market
  # Share Holdings
  yesShares: BigInt! # YES shares held
  noShares: BigInt! # NO shares held
  # Investment Tracking (for P/L calculation)
  totalInvested: BigDecimal! # Total BNB invested (cost basis)
  totalReturned: BigDecimal! # Total BNB returned from sells
  averageYesPrice: BigDecimal! # Avg price paid for YES
  averageNoPrice: BigDecimal! # Avg price paid for NO
  # Net cost basis (for resolution P/L)
  netCostBasis: BigDecimal! # totalInvested - totalReturned (what's "at risk")
  # Claim Status
  claimed: Boolean! # Has user claimed?
  claimedAmount: BigDecimal # Amount claimed (if claimed)
  emergencyRefunded: Boolean! # Has user emergency refunded?
  refundedAmount: BigDecimal # Amount refunded (if refunded)
  # P/L for this position (calculated on resolution)
  realizedPnL: BigDecimal # claimedAmount - netCostBasis (null if not resolved)
  # Voting
  hasVoted: Boolean! # Has user voted?
  votedForProposer: Boolean # null if not voted
}

# ============================================
# Vote Entity - Voting records for disputed markets
# ============================================
type Vote @entity(immutable: true) {
  id: ID! # marketId-voterAddress
  market: Market! # Related market
  voter: User! # Voter (relation)
  voterAddress: Bytes! # Voter address (for filtering)
  # Vote Details
  supportedProposer: Boolean! # true = voted for proposer, false = for disputer
  weight: BigInt! # Vote weight (total shares)
  # Transaction Info
  timestamp: BigInt! # Block timestamp
  txHash: Bytes! # Transaction hash
  blockNumber: BigInt! # Block number
}

# ============================================
# Claim Entity - Payout claims
# ============================================
type Claim @entity(immutable: true) {
  id: ID! # txHash-logIndex
  market: Market! # Related market
  user: User! # User who claimed
  userAddress: Bytes! # User address (for filtering)
  # Claim Details
  amount: BigDecimal! # Amount claimed in BNB
  # Transaction Info
  timestamp: BigInt! # Block timestamp
  txHash: Bytes! # Transaction hash
  blockNumber: BigInt! # Block number
}

# ============================================
# EmergencyRefund Entity - Emergency refund records
# ============================================
type EmergencyRefund @entity(immutable: true) {
  id: ID! # txHash-logIndex
  market: Market! # Related market
  user: User! # User who got refund
  userAddress: Bytes! # User address (for filtering)
  # Refund Details
  amount: BigDecimal! # Amount refunded in BNB
  # Transaction Info
  timestamp: BigInt! # Block timestamp
  txHash: Bytes! # Transaction hash
  blockNumber: BigInt! # Block number
}

# ============================================
# GlobalStats Entity - Platform-wide statistics
# ============================================
type GlobalStats @entity(immutable: false) {
  id: ID! # "global" (singleton)
  # Market Stats
  totalMarkets: BigInt! # Total markets created
  activeMarkets: BigInt! # Markets not yet resolved
  resolvedMarkets: BigInt! # Markets resolved
  # Volume Stats
  totalVolume: BigDecimal! # Total BNB traded
  totalTrades: BigInt! # Total trades across all markets
  # User Stats
  totalUsers: BigInt! # Unique traders
  # Resolution Stats
  totalClaimed: BigDecimal! # Total payouts claimed
  totalRefunded: BigDecimal! # Total emergency refunds
  disputedMarkets: BigInt! # Markets that were disputed
  # Governance Stats (v3.1.0)
  totalSwept: BigDecimal! # Total BNB swept by MultiSig
}

# ============================================
# FundsSweep Entity - MultiSig sweep records (v3.1.0)
# ============================================
type FundsSweep @entity(immutable: true) {
  id: ID! # txHash-logIndex
  # Sweep Details
  amount: BigDecimal! # Amount swept in BNB
  totalLocked: BigDecimal! # Total locked funds at time of sweep
  contractBalance: BigDecimal! # Contract balance at time of sweep
  # Transaction Info
  timestamp: BigInt! # Block timestamp
  txHash: Bytes! # Transaction hash
  blockNumber: BigInt! # Block number
}

# ============================================
# ProposerReward Entity - Proposer rewards (v3.3.0)
# ============================================
type ProposerReward @entity(immutable: true) {
  id: ID! # txHash-logIndex
  market: Market! # Related market
  proposer: User! # Proposer who received reward
  proposerAddress: Bytes! # Proposer address (for filtering)
  # Reward Details
  amount: BigDecimal! # Amount rewarded in BNB (0.5% of pool)
  # Transaction Info
  timestamp: BigInt! # Block timestamp
  txHash: Bytes! # Transaction hash
  blockNumber: BigInt! # Block number
}

# ============================================
# WithdrawalCredit Entity - Pull Pattern credits (v3.4.0)
# ============================================
type WithdrawalCredit @entity(immutable: true) {
  id: ID! # txHash-logIndex
  user: User! # User credited
  userAddress: Bytes! # User address (for filtering)
  # Credit Details
  amount: BigDecimal! # Amount credited in BNB
  reason: String! # Reason: "proposer_bond_reward", "bond_winner", "jury_fee", etc.
  # Transaction Info
  timestamp: BigInt! # Block timestamp
  txHash: Bytes! # Transaction hash
  blockNumber: BigInt! # Block number
}

# ============================================
# WithdrawalClaim Entity - Pull Pattern claims (v3.4.0)
# ============================================
type WithdrawalClaim @entity(immutable: true) {
  id: ID! # txHash-logIndex
  user: User! # User who claimed
  userAddress: Bytes! # User address (for filtering)
  # Claim Details
  amount: BigDecimal! # Amount claimed in BNB
  # Transaction Info
  timestamp: BigInt! # Block timestamp
  txHash: Bytes! # Transaction hash
  blockNumber: BigInt! # Block number
}

# ============================================
# CreatorFeeCredit Entity - Creator fees credited (v3.4.0)
# ============================================
type CreatorFeeCredit @entity(immutable: true) {
  id: ID! # txHash-logIndex
  creator: User! # Creator credited
  creatorAddress: Bytes! # Creator address (for filtering)
  market: Market! # Related market
  # Credit Details
  amount: BigDecimal! # Amount credited in BNB
  # Transaction Info
  timestamp: BigInt! # Block timestamp
  txHash: Bytes! # Transaction hash
  blockNumber: BigInt! # Block number
}

# ============================================
# CreatorFeeClaim Entity - Creator fees claimed (v3.4.0)
# ============================================
type CreatorFeeClaim @entity(immutable: true) {
  id: ID! # txHash-logIndex
  creator: User! # Creator who claimed
  creatorAddress: Bytes! # Creator address (for filtering)
  # Claim Details
  amount: BigDecimal! # Amount claimed in BNB
  # Transaction Info
  timestamp: BigInt! # Block timestamp
  txHash: Bytes! # Transaction hash
  blockNumber: BigInt! # Block number
}
